name: DeepSeek CEO & CTO v4.0
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  ceo_mode:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Proje SahasÄ±nÄ± Tarama
        uses: actions/checkout@v4

      - name: DeepSeek CEO Botu Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             * â•‘        DEEPSEEK CEO & CTO EDITION v4.0 (AUTONOMOUS)           â•‘
             * â•‘        Ã–zellikler: Planlama, DokÃ¼mantasyon, BaÄŸÄ±mlÄ±lÄ±k Analiziâ•‘
             * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */
            
            console.log("ðŸš€ [CEO v4.0] YÃ¶netim Kurulu ToplanÄ±yor...");
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("API AnahtarÄ± eksik!");

            // --- 1. ADIM: MEVCUT PROJE ANALÄ°ZÄ° (GÃ–ZLER) ---
            // Sadece bahsedilenleri deÄŸil, kritik yapÄ±landÄ±rma dosyalarÄ±nÄ± da her zaman oku.
            const criticalFiles = ['package.json', 'requirements.txt', 'README.md', 'composer.json', 'pom.xml'];
            
            // Regex ile mesajda geÃ§en dosya isimlerini bul
            const fileMentionRegex = /\b[\w-]+\.(js|py|html|css|json|md|yml|txt|java|c|cpp|go|rs|php|sql)\b/g;
            const mentionedFiles = [...new Set(userMessage.match(fileMentionRegex) || [])];
            
            // Hepsini birleÅŸtir
            const filesToRead = [...new Set([...criticalFiles, ...mentionedFiles])];
            
            let currentContext = "";
            console.log("ðŸ‘€ [CEO] Proje dosyalarÄ± inceleniyor...");

            for (const file of filesToRead) {
              try {
                const { data: fileData } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: file
                });
                
                if (fileData.encoding === 'base64' && fileData.type === 'file') {
                  const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
                  // 5000 karakterden fazlasÄ±nÄ± kes (HafÄ±za tasarrufu)
                  const safeContent = content.length > 5000 ? content.substring(0, 5000) + "\n...[Kesildi]" : content;
                  currentContext += `\n>>> DOSYA: ${file} <<<\n${safeContent}\n---DOSYA SONU---\n`;
                  console.log(`ðŸ“– Okundu: ${file}`);
                }
              } catch (e) {
                // Dosya yoksa sorun deÄŸil, belki yeni oluÅŸturulacaktÄ±r.
              }
            }

            // --- 2. ADIM: CEO MANTIÄžI (PROMPT) ---
            const systemPrompt = `
            Sen DEEPSEEK CEO & CTO (v4.0), projenin otonom yÃ¶neticisisin.
            Sadece kod yazma; projeyi YÃ–NET.
            
            GÃ–REVÄ°N:
            KullanÄ±cÄ±nÄ±n isteÄŸini analiz et ve projeyi en profesyonel standartlara taÅŸÄ±.
            
            KURALLAR VE YETENEKLER:
            1. **Zincirleme DÃ¼ÅŸÃ¼nce:** Kod yazmadan Ã¶nce ne yapacaÄŸÄ±nÄ± planla.
            2. **BaÄŸÄ±mlÄ±lÄ±k YÃ¶netimi:** EÄŸer yeni bir kÃ¼tÃ¼phane (Ã¶rn. 'requests', 'axios') kullanÄ±rsan, mutlaka 'requirements.txt' veya 'package.json' dosyasÄ±nÄ± da GÃœNCELLE.
            3. **Oto-DokÃ¼mantasyon:** YaptÄ±ÄŸÄ±n deÄŸiÅŸikliÄŸi 'README.md' dosyasÄ±na "GÃ¼ncelleme Notu" olarak ekle.
            4. **Tam Uyumluluk:** Mevcut kodlarÄ± bozma, geliÅŸtir.
            
            Ã‡IKTI FORMATI (ASLA BOZMA):
            Dosya iÅŸlemleri iÃ§in:
            ---FILENAME: yol/dosya_adi.uzantÄ±---
            [Kodun TAMAMI]
            ---END_OF_FILE---
            
            Silme iÅŸlemleri iÃ§in:
            ---DELETE: yol/dosya_adi.uzantÄ±---
            ---END_DELETE---
            `.trim();

            console.log("ðŸ§  [CEO] Strateji belirleniyor ve kodlanÄ±yor...");
            
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: systemPrompt },
                  { 
                    role: "user", 
                    content: `KULLANICI EMRÄ°: ${userMessage}\n\nMEVCUT PROJE DURUMU:\n${currentContext}` 
                  }
                ],
                temperature: 0.1, // Hata yapma lÃ¼ksÃ¼ yok
                stream: false,
                max_tokens: 8000
              })
            });

            if (!response.ok) {
               const errText = await response.text();
               throw new Error(`DeepSeek HatasÄ±: ${errText}`);
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;
            console.log(`âš¡ Plan HazÄ±rlandÄ± (${aiReply.length} karakter)`);

            // --- 3. ADIM: UYGULAMA (EXECUTION) ---
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            
            let match;
            let filesUpdated = [];
            let filesDeleted = [];
            let errors = [];

            // Dosya OluÅŸturma/GÃ¼ncelleme
            while ((match = fileRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              const fcont = match[2].trim();
              
              try {
                let sha;
                try {
                  const { data: existing } = await github.rest.repos.getContent({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname
                  });
                  sha = existing.sha;
                } catch (e) {}

                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `CEO v4.0: ${fname} gÃ¼ncellendi`,
                  content: Buffer.from(fcont).toString('base64'),
                  sha: sha
                });
                filesUpdated.push(fname);
                console.log(`âœ… UygulandÄ±: ${fname}`);
              } catch (err) {
                errors.push(`${fname}: ${err.message}`);
              }
            }

            // Dosya Silme
            while ((match = delRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              if (['.github/workflows/main.yml'].includes(fname)) continue; // Kendini silemez
              
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                await github.rest.repos.deleteFile({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `CEO v4.0: ${fname} silindi`,
                  sha: existing.sha
                });
                filesDeleted.push(fname);
              } catch (e) {}
            }

            // --- 4. ADIM: YÃ–NETÄ°CÄ° RAPORU ---
            let report = `### ðŸ‘” DeepSeek CEO & CTO v4.0 Raporu\n\n`;
            
            if (filesUpdated.length > 0) {
              report += `#### ðŸš€ GerÃ§ekleÅŸen Ä°craatlar:\n`;
              filesUpdated.forEach(f => {
                 if(f.includes('README')) report += `- ðŸ“˜ **DokÃ¼mantasyon:** \`${f}\` gÃ¼ncellendi.\n`;
                 else if(f.includes('requirements') || f.includes('package.json')) report += `- ðŸ“¦ **BaÄŸÄ±mlÄ±lÄ±klar:** \`${f}\` yÃ¶netildi.\n`;
                 else report += `- ðŸ› ï¸ **Kod:** \`${f}\` geliÅŸtirildi.\n`;
              });
            }
            
            if (filesDeleted.length > 0) {
               report += `\n#### ðŸ—‘ï¸ Temizlenenler:\n`;
               filesDeleted.forEach(f => report += `- \`${f}\` silindi.\n`);
            }

            if (errors.length > 0) {
               report += `\nâš ï¸ **Dikkat Gerekenler:**\n`;
               errors.forEach(e => report += `- ${e}\n`);
            }

            // AI'nin aÃ§Ä±klama kÄ±smÄ±nÄ± (kod bloklarÄ± hariÃ§) rapora ekle
            const cleanDescription = aiReply.replace(/---FILENAME[\s\S]*?---END_OF_FILE---/g, '').replace(/---DELETE[\s\S]*?---END_DELETE---/g, '').trim();
            if (cleanDescription.length > 0) {
               report += `\n---\n**ðŸ’¡ CEO'nun Notu:**\n\n${cleanDescription.substring(0, 1500)}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
