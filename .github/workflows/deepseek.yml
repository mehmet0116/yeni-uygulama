name: DeepSeek Asistan覺
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  deepseek_calisiyor:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: DeepSeek ile Iletisim
        uses: actions/github-script@v6
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            
            // DUZELTME BURADA: .trim() ekleyerek bosluklari temizliyoruz
            const cleanKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";

            if (!cleanKey) {
              throw new Error("API Anahtar覺 bulunamadi! Lutfen Secrets ayarlarini kontrol edin.");
            }

            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${cleanKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: "Sen uzman bir yaz覺l覺mc覺s覺n. T羹rk癟e cevap ver." },
                  { role: "user", content: userMessage }
                ],
                stream: false
              })
            });

            if (!response.ok) {
              console.log("HATA: API Yaniti basarisiz oldu.");
              console.log(await response.text());
              throw new Error("DeepSeek API hatasi: " + response.statusText);
            }

            const data = await response.json();
            
            if (!data.choices || !data.choices[0]) {
               console.log("Gelen veri:", JSON.stringify(data));
               throw new Error("API'den cevap donmedi veya format yanlis.");
            }

            const aiReply = data.choices[0].message.content;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: " **DeepSeek:**\n" + aiReply
            });
