name: DeepSeek ULTRA Enterprise Architect
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  ultra_architect:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Ultra GÃ¼venli Depo Checkout
        uses: actions/checkout@v4

      - name: DeepSeek ULTRA Architect Bot Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             * â•‘       ULTRA ENTERPRISE ARCHITECT BOT v2.0                     â•‘
             * â•‘       Powered by DeepSeek AI                                  â•‘
             * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * 
             * Ã–zellikler:
             * âœ“ SÄ±fÄ±r hata toleransÄ± ile %100 otomasyon
             * âœ“ Enterprise-level gÃ¼venlik ve validasyon
             * âœ“ KapsamlÄ± hata yÃ¶netimi ve loglama
             * âœ“ Profesyonel raporlama sistemi
             * âœ“ KorumalÄ± dosya yÃ¶netimi
             * âœ“ DetaylÄ± API iletiÅŸim takibi
             * 
             * GeliÅŸtiricinin hiÃ§bir adÄ±mda elle ekleyecek tek satÄ±r bÄ±rakmaz.
             */

            //---------- Sistemi Koruyan Sabitler ve Kontroller ----------
            console.log("ğŸš€ [Ultra Bot] Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...");
            console.log(`ğŸ“ [Ultra Bot] Event: ${context.eventName}`);
            
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            function throwCritical(msg) {
              console.error(`â€¼ï¸ [Ultra Bot Kritik Hata]: ${msg}`);
              throw new Error("â€¼ï¸ [Ultra Bot Kritik]: " + msg);
            }
            
            if (!apiKey) throwCritical("API anahtarÄ± yÃ¼klÃ¼ deÄŸil! DEEPSEEK_API_KEY secret'Ä±nÄ± ekleyin.");
            if (!userMessage || userMessage.trim().length === 0) throwCritical("KullanÄ±cÄ± mesajÄ± boÅŸ!");
            
            console.log(`âœ… [Ultra Bot] Validasyonlar baÅŸarÄ±lÄ±. Mesaj uzunluÄŸu: ${userMessage.length} karakter`);

            //---------- EndÃ¼stri Lideri Prompt (HiÃ§bir AÃ§Ä±k Yok) ----------
            const systemPrompt = `
Sen 1 numaralÄ± global yazÄ±lÄ±m (ULTRA ENTERPRISE) mimarÄ±sÄ±n.
Her geliÅŸtirme sorumluluÄŸun; kod, mimari, gÃ¼venlik, sÃ¼rdÃ¼rÃ¼lebilirlik, Ã¶lÃ§eklenebilirlik, ultra temizlik ve %100 iÅŸlevdir.

++ KURUMSAL KURALLAR ++
- Daima modÃ¼ler ve en iyi klasÃ¶r yapÄ±sÄ±nÄ± kur.
- Kod iÃ§ine anlamlÄ±, aÃ§Ä±klayÄ±cÄ±, ENGLISH ve TURKISH yorum ekle. (Kodun baÅŸÄ±nda ve Ã¶nemli bloklarda)
- Kod, dÃ¶kÃ¼mantasyon, test, ortam dosyasÄ± (Ã¶r: .env.example), gereksiz bÄ±rakÄ±lamaz.
- Her dosya sadece ilgi alanÄ±nÄ± kapsayacak.
- En az: src/, tests/, docs/, configs/, .env.example, readme.md Ã§Ä±kmalÄ±, dil uygunsa dockerfile ve CI/Cd Ã¶rneÄŸi olmalÄ±.
- Dosya silinmesi istenirse, kullanÄ±cÄ± "sil: ..." (sil/comma/space) ile belirtir. Ultra gÃ¼venli sil.
- HiÃ§bir ÅŸekilde sohbet ya da insan gibi mesajlaÅŸma, ek format, yan not kullanÄ±lamaz.
- Her dosya ve silme iÅŸlemi Ã–ZEL formatta olmalÄ±.

++ DOSYA EKLE-GÃœNCELLE BLOK FORMAT ++
---FILENAME: path/name.ext---
KODUN TAMAMI (gerekli aÃ§Ä±klamalarla)
---END_OF_FILE---

++ DOSYA SÄ°LME BLOK FORMAT ++
---DELETE: path/filename.ext---
---END_DELETE---

++ Ã–RNEK ++
---FILENAME: src/main.py---
# [EN] Main entrypoint | [TR] Ana giriÅŸ noktasÄ±
print("App started (BaÅŸladÄ±)")
---END_OF_FILE---
---DELETE: src/old.py---
---END_DELETE---

Print only file/silme bloklarÄ±nÄ± Ã¼ret, sohbet veya Ã¶neri eklenemez.
            `.trim();

            //---------- DeepSeek ile Ultra GÃ¼venli Ä°letiÅŸim ----------
            console.log("ğŸŸ¢ [Ultra Bot] DeepSeek API Ã§aÄŸrÄ±sÄ± baÅŸlatÄ±lÄ±yor...");
            const apiUrl = "https://api.deepseek.com/v1/chat/completions";
            console.log(`ğŸŒ [Ultra Bot] Endpoint: ${apiUrl}`);
            
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: "PROJE TALEBÄ°: " + userMessage }
                ],
                temperature: 0.15,
                stream: false,
                max_tokens: 4000
              })
            });
            
            console.log(`ğŸ“¡ [Ultra Bot] HTTP Status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
              const errText = await response.text();
              console.error(`âŒ [Ultra Bot] API Error: ${response.status} - ${errText}`);
              throwCritical(`DeepSeek API hatasÄ± (${response.status}): ${errText}`);
            }
            
            const data = await response.json();
            console.log(`âœ… [Ultra Bot] API yanÄ±tÄ± alÄ±ndÄ±`);
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
              throwCritical("API yanÄ±tÄ± beklenmeyen formatta");
            }
            
            const aiReply = data.choices[0].message.content;
            console.log(`ğŸ“ [Ultra Bot] AI yanÄ±t boyutu: ${aiReply.length} karakter`);

            //---------- Dosya BLOKLARI: Ekle/GÃ¼ncelle/Logla ----------
            console.log("ğŸ“ [Ultra Bot] Dosya bloklarÄ±nÄ± iÅŸlemeye baÅŸlÄ±yor...");
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            let match, filesDone=[], filesProblems=[];
            let resultLog = "### ğŸŸ¢ Ultra Enterprise SonuÃ§ Raporu\n\n";
            resultLog += `**ğŸ“… Tarih:** ${new Date().toISOString()}\n`;
            resultLog += `**ğŸ‘¤ Ä°stek:** @${context.actor}\n\n`;
            
            while ((match = fileRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              const fcont = match[2].trim();
              
              console.log(`ğŸ“ [Ultra Bot] Ä°ÅŸleniyor: ${fname} (${fcont.length} bytes)`);
              
              // Basit gÃ¼venlik kontrolÃ¼
              if (!fname || fname.includes('..') || fname.startsWith('/')) {
                filesProblems.push({fname, err: 'GeÃ§ersiz dosya adÄ±'});
                resultLog += `\nâŒ \`${fname}\` - GeÃ§ersiz dosya adÄ±`;
                continue;
              }
              
              let sha = undefined;
              // SHA bul (varsa)
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                sha = existing.sha;
              } catch(_) {/* dosya yoksa */}
              
              // KayÄ±t/GÃ¼ncelle
              try {
                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `[ULTRA BOT]: ${fname} ${sha ? 'gÃ¼ncellendi' : 'oluÅŸturuldu'}`,
                  content: Buffer.from(fcont).toString('base64'), sha
                });
                filesDone.push(fname);
                resultLog += `\nâœ… \`${fname}\` ${sha ? 'gÃ¼ncellendi' : 'oluÅŸturuldu'}`;
                console.log(`âœ… [Ultra Bot] BaÅŸarÄ±lÄ±: ${fname}`);
              } catch (err) {
                filesProblems.push({fname, err: err.message});
                resultLog += `\nâŒ \`${fname}\`: ${err.message}`;
                console.error(`âŒ [Ultra Bot] Hata ${fname}: ${err.message}`);
              }
            }
            console.log(`ğŸ“ [Ultra Bot] Dosya iÅŸleme tamamlandÄ±: ${filesDone.length} baÅŸarÄ±lÄ±`);

            //---------- SILME BLOKLARI: Ultra DetaylÄ± ----------
            console.log("ğŸ—‘ï¸ [Ultra Bot] Silme bloklarÄ±nÄ± iÅŸlemeye baÅŸlÄ±yor...");
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            let delDone=[], delFail=[];
            let delMatch;
            
            while ((delMatch = delRE.exec(aiReply)) !== null) {
              const fname = delMatch[1].trim();
              
              console.log(`ğŸ—‘ï¸ [Ultra Bot] Siliniyor: ${fname}`);
              
              // GÃ¼venlik kontrolÃ¼
              if (!fname || fname.includes('..') || fname.startsWith('/')) {
                delFail.push({fname, err: 'GeÃ§ersiz dosya adÄ±'});
                resultLog += `\nâš ï¸ \`${fname}\` - GeÃ§ersiz dosya adÄ±`;
                continue;
              }
              
              // Kritik dosyalarÄ± koruma
              const protectedFiles = [
                '.gitignore', 
                'README.md', 
                '.github/workflows/deepseek.yml',
                'package.json',
                'package-lock.json',
                'yarn.lock',
                'requirements.txt',
                'Gemfile',
                'Gemfile.lock',
                'go.mod',
                'go.sum',
                'Cargo.toml',
                'Cargo.lock'
              ];
              if (protectedFiles.includes(fname)) {
                delFail.push({fname, err: 'KorumalÄ± dosya'});
                resultLog += `\nğŸ›¡ï¸ \`${fname}\` - KorumalÄ± dosya`;
                console.warn(`ğŸ›¡ï¸ [Ultra Bot] KorumalÄ±: ${fname}`);
                continue;
              }
              
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                await github.rest.repos.deleteFile({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `[ULTRA BOT]: ${fname} silindi`,
                  sha: existing.sha
                });
                delDone.push(fname);
                resultLog += `\nğŸ—‘ï¸ \`${fname}\` silindi`;
                console.log(`âœ… [Ultra Bot] Silindi: ${fname}`);
              } catch(err) {
                delFail.push({fname, err: err.message});
                resultLog += `\nâš ï¸ \`${fname}\`: ${err.message}`;
                console.error(`âŒ [Ultra Bot] Silme hatasÄ±: ${err.message}`);
              }
            }
            console.log(`ğŸ—‘ï¸ [Ultra Bot] Silme tamamlandÄ±: ${delDone.length} baÅŸarÄ±lÄ±`);

            //---------- Nihai KURUMSAL RAPOR ve Log SonlandÄ±rma ----------
            const totalOps = filesDone.length + delDone.length;
            const totalErrors = filesProblems.length + delFail.length;
            
            resultLog += `\n\n---\n### ğŸ“Š Ä°ÅŸlem Ã–zeti\n`;
            resultLog += `- âœ… **BaÅŸarÄ±lÄ±:** ${totalOps} iÅŸlem\n`;
            resultLog += `- âŒ **HatalÄ±:** ${totalErrors} iÅŸlem\n`;
            resultLog += `- ğŸ“ **OluÅŸturulan/GÃ¼ncellenen:** ${filesDone.length} dosya\n`;
            resultLog += `- ğŸ—‘ï¸ **Silinen:** ${delDone.length} dosya\n`;
            
            if (filesProblems.length > 0) {
              resultLog += `\n### âš ï¸ OluÅŸturulamayan Dosyalar\n`;
              for (const fp of filesProblems) resultLog += `- \`${fp.fname}\`: ${fp.err}\n`;
            }
            if (delFail.length > 0) {
              resultLog += `\n### âš ï¸ Silinemeyen Dosyalar\n`;
              for (const df of delFail) resultLog += `- \`${df.fname}\`: ${df.err}\n`;
            }
            if (filesDone.length === 0 && delDone.length === 0) {
              resultLog += `\n---\n### â„¹ï¸ Bilgi\n`;
              resultLog += `AI yanÄ±tÄ±nda dosya/silme bloÄŸu tespit edilmedi.\n\n`;
              // GÃ¼venlik: AI yanÄ±tÄ±nÄ± sÄ±nÄ±rlÄ± ve sanitize edilmiÅŸ ÅŸekilde gÃ¶ster
              const maxPreviewLength = 500;
              const sanitizedReply = aiReply.substring(0, maxPreviewLength).replace(/[<>]/g, '');
              resultLog += `<details><summary>AI YanÄ±t Ã–nizlemesi (ilk ${maxPreviewLength} karakter)</summary>\n\n\`\`\`\n${sanitizedReply}${aiReply.length > maxPreviewLength ? '\n...(kÄ±saltÄ±ldÄ±)' : ''}\n\`\`\`\n</details>`;
            }
            
            resultLog += `\n\n---\n*ğŸ¤– DeepSeek ULTRA Enterprise Architect v2.0 | Powered by AI*`;
            
            console.log(`ğŸ“¤ [Ultra Bot] Rapor gÃ¶nderiliyor...`);
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: resultLog
            });

            //---------- Ultra Professional: Nihai Not ----------
            console.log(`\n${'='.repeat(50)}`);
            console.log(`ğŸ‰ [ULTRA BOT] Ä°ÅŸlem TamamlandÄ±!`);
            console.log(`ğŸ“Š Toplam: ${totalOps} baÅŸarÄ±lÄ±, ${totalErrors} hatalÄ±`);
            console.log(`âœ¨ TÃ¼m talepler profesyonel kaliteyle karÅŸÄ±landÄ±.`);
            console.log(`${'='.repeat(50)}\n`);
