name: DeepSeek V3.2 AGENT ARCHITECT (Reasoning-First)
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  agent_v3_2:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Proje SahasÄ±nÄ± Tarama
        uses: actions/checkout@v4

      - name: DeepSeek V3.2 AjanÄ±nÄ± Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             * â•‘        DEEPSEEK V3.2 AGENT ARCHITECT (REASONING-FIRST)        â•‘
             * â•‘        Motor: DeepSeek V3.2 (Reasoning Mode)                  â•‘
             * â•‘        Ã–zellik: DÃ¼ÅŸÃ¼nce Zinciri (CoT) & Otonom Karar          â•‘
             * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */
            
            console.log("ğŸš€ [V3.2 AGENT] AkÄ±l yÃ¼rÃ¼tme motoru baÅŸlatÄ±lÄ±yor...");
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("API AnahtarÄ± eksik!");

            // --- 1. BAÄLAM TOPLAMA (CONTEXT) ---
            // AjanÄ±mÄ±z karar vermeden Ã¶nce ortamÄ± kokluyor
            const criticalFiles = ['package.json', 'requirements.txt', 'README.md', 'pubspec.yaml', 'go.mod'];
            const fileMentionRegex = /\b[\w-]+\.(js|py|html|css|json|md|yml|txt|java|c|cpp|go|rs|php|sql|ts|tsx)\b/g;
            const mentionedFiles = [...new Set(userMessage.match(fileMentionRegex) || [])];
            const filesToRead = [...new Set([...criticalFiles, ...mentionedFiles])];
            
            let currentContext = "";
            console.log("ğŸ‘€ [V3.2] Dosya analizi yapÄ±lÄ±yor...");

            for (const file of filesToRead) {
              try {
                const { data: fileData } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: file
                });
                if (fileData.encoding === 'base64' && fileData.type === 'file') {
                  const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
                  const safeContent = content.length > 6000 ? content.substring(0, 6000) + "\n...[Kesildi]" : content;
                  currentContext += `\n>>> DOSYA: ${file} <<<\n${safeContent}\n---DOSYA SONU---\n`;
                }
              } catch (e) {}
            }

            // --- 2. V3.2 REASONING PROMPT ---
            // "Reasoning-first" olduÄŸu iÃ§in prompt'u stratejik dÃ¼ÅŸÃ¼nmeye zorluyoruz.
            const systemPrompt = `
            Sen DeepSeek V3.2 ile gÃ¼Ã§lendirilmiÅŸ otonom bir YazÄ±lÄ±m AjanÄ±sÄ±n (AI Software Agent).
            
            TEMEL GÃ–REVÄ°N:
            Sadece kod yazmak deÄŸil; bir sorunu "Reasoning" (AkÄ±l YÃ¼rÃ¼tme) yeteneÄŸinle analiz edip en mantÄ±klÄ± Ã§Ã¶zÃ¼mÃ¼ uygulamak.
            
            V3.2 KURALLARI:
            1. **DÃ¼ÅŸÃ¼nce Zinciri:** Kod yazmadan Ã¶nce adÄ±m adÄ±m planla. Hata olasÄ±lÄ±klarÄ±nÄ± Ã¶nceden gÃ¶r.
            2. **Ajan DavranÄ±ÅŸÄ±:** Dosya yapÄ±sÄ±nÄ±, baÄŸÄ±mlÄ±lÄ±klarÄ± ve dokÃ¼mantasyonu bir bÃ¼tÃ¼n olarak yÃ¶net.
            3. **Kesinlik:** YazdÄ±ÄŸÄ±n kod "ilk seferde Ã§alÄ±ÅŸÄ±r" (first-shot success) kalitede olmalÄ±.
            
            Ã‡IKTI FORMATI (SÄ°STEM BUNU BEKLÄ°YOR):
            ---FILENAME: yol/dosya_adi.uzantÄ±---
            [Kod]
            ---END_OF_FILE---
            
            ---DELETE: yol/dosya_adi.uzantÄ±---
            ---END_DELETE---
            `.trim();

            console.log("ğŸ§  [V3.2] Derin dÃ¼ÅŸÃ¼nme (Reasoning) sÃ¼reci baÅŸladÄ±...");
            
            // --- API AYARI: REASONER MODELÄ° ---
            // BURASI Ã–NEMLÄ°: V3.2 "Reasoning" Ã¶zelliÄŸini kullanmak iÃ§in modeli gÃ¼ncelledik.
            // EÄŸer V3.2 iÃ§in Ã¶zel bir slug yayÄ±nlandÄ±ysa (Ã¶rn: deepseek-v3.2), 'deepseek-reasoner' yerine onu yazabilirsin.
            // Åu an 'deepseek-reasoner' en gÃ¼Ã§lÃ¼ mantÄ±k modelidir.
            
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-reasoner", // VEYA "deepseek-chat" (V3.2 main ise)
                messages: [
                  { role: "system", content: systemPrompt },
                  { 
                    role: "user", 
                    content: `GÃ–REV: ${userMessage}\n\nMEVCUT PROJE DURUMU:\n${currentContext}` 
                  }
                ],
                stream: false,
                max_tokens: 8000 // Reasoning modelleri daha uzun cevap Ã¼retir
              })
            });

            if (!response.ok) {
               const errText = await response.text();
               throw new Error(`DeepSeek API HatasÄ±: ${errText}`);
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;
            
            // Reasoning modelleri bazen "thought" (dÃ¼ÅŸÃ¼nce) kÄ±smÄ±nÄ± ayrÄ± verir.
            // EÄŸer API "reasoning_content" dÃ¶ndÃ¼rÃ¼yorsa onu da rapora ekleyelim.
            const reasoningLog = data.choices[0].message.reasoning_content || "";
            
            console.log(`âš¡ Ã‡Ã¶zÃ¼m Ãœretildi (${aiReply.length} karakter)`);

            // --- 3. UYGULAMA ---
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            
            let match;
            let filesUpdated = [];
            let filesDeleted = [];

            while ((match = fileRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              const fcont = match[2].trim();
              try {
                let sha;
                try {
                  const { data: existing } = await github.rest.repos.getContent({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname
                  });
                  sha = existing.sha;
                } catch (e) {}

                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `DeepSeek V3.2 Agent: ${fname}`,
                  content: Buffer.from(fcont).toString('base64'),
                  sha: sha
                });
                filesUpdated.push(fname);
              } catch (err) { console.error(err); }
            }

            while ((match = delRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              if (['.github/workflows/main.yml'].includes(fname)) continue;
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                await github.rest.repos.deleteFile({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `DeepSeek V3.2 Silme: ${fname}`,
                  sha: existing.sha
                });
                filesDeleted.push(fname);
              } catch (e) {}
            }

            // --- 4. RAPOR ---
            let report = `### ğŸ§  DeepSeek V3.2 Agent Raporu\n\n`;
            
            if (reasoningLog) {
              // DÃ¼ÅŸÃ¼nce sÃ¼recini gÃ¶ster (Bu V3.2'nin en havalÄ± Ã¶zelliÄŸi)
              report += `<details><summary>ğŸ¤” AjanÄ±n DÃ¼ÅŸÃ¼nce Zinciri (TÄ±kla GÃ¶r)</summary>\n\n\`\`\`text\n${reasoningLog.substring(0, 2000)}...\n\`\`\`\n</details>\n\n`;
            }
            
            report += `**ğŸ› ï¸ YapÄ±lan Ä°ÅŸlemler:**\n`;
            filesUpdated.forEach(f => report += `- âœ… OluÅŸturuldu/GÃ¼ncellendi: \`${f}\`\n`);
            filesDeleted.forEach(f => report += `- ğŸ—‘ï¸ Silindi: \`${f}\`\n`);
            
            if (filesUpdated.length === 0 && filesDeleted.length === 0) {
               report += `\n**ğŸ’¡ Cevap:**\n${aiReply}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
