name: DeepSeek ULTRA Enterprise Architect
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  ultra_architect:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Ultra GÃ¼venli Depo Checkout
        uses: actions/checkout@v4

      - name: DeepSeek ULTRA Architect Bot Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * ::: ULTRA ENTERPRISE ARCHITECT BOT :::
             * SÄ±fÄ±r hata toleransÄ±, %100 otomasyon, enterprise-level gÃ¼venlik!
             * GeliÅŸtiricinin hiÃ§bir adÄ±mda elle ekleyecek tek satÄ±r bÄ±rakmaz.
             */

            //---------- Sistemi Koruyan Sabitler ve Kontroller ----------
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            function throwCritical(msg) { throw new Error("â€¼ï¸ [Ultra Bot Kritik]: " + msg); }
            if (!apiKey) throwCritical("API anahtarÄ± yÃ¼klÃ¼ deÄŸil! Sistemi yÃ¶neticinizle acil gÃ¶rÃ¼ÅŸÃ¼n.");

            //---------- EndÃ¼stri Lideri Prompt (HiÃ§bir AÃ§Ä±k Yok) ----------
            const systemPrompt = `
Sen 1 numaralÄ± global yazÄ±lÄ±m (ULTRA ENTERPRISE) mimarÄ±sÄ±n.
Her geliÅŸtirme sorumluluÄŸun; kod, mimari, gÃ¼venlik, sÃ¼rdÃ¼rÃ¼lebilirlik, Ã¶lÃ§eklenebilirlik, ultra temizlik ve %100 iÅŸlevdir.

++ KURUMSAL KURALLAR ++
- Daima modÃ¼ler ve en iyi klasÃ¶r yapÄ±sÄ±nÄ± kur.
- Kod iÃ§ine anlamlÄ±, aÃ§Ä±klayÄ±cÄ±, ENGLISH ve TURKISH yorum ekle. (Kodun baÅŸÄ±nda ve Ã¶nemli bloklarda)
- Kod, dÃ¶kÃ¼mantasyon, test, ortam dosyasÄ± (Ã¶r: .env.example), gereksiz bÄ±rakÄ±lamaz.
- Her dosya sadece ilgi alanÄ±nÄ± kapsayacak.
- En az: src/, tests/, docs/, configs/, .env.example, readme.md Ã§Ä±kmalÄ±, dil uygunsa dockerfile ve CI/Cd Ã¶rneÄŸi olmalÄ±.
- Dosya silinmesi istenirse, kullanÄ±cÄ± "sil: ..." (sil/comma/space) ile belirtir. Ultra gÃ¼venli sil.
- HiÃ§bir ÅŸekilde sohbet ya da insan gibi mesajlaÅŸma, ek format, yan not kullanÄ±lamaz.
- Her dosya ve silme iÅŸlemi Ã–ZEL formatta olmalÄ±.

++ DOSYA EKLE-GÃœNCELLE BLOK FORMAT ++
---FILENAME: path/name.ext---
KODUN TAMAMI (gerekli aÃ§Ä±klamalarla)
---END_OF_FILE---

++ DOSYA SÄ°LME BLOK FORMAT ++
---DELETE: path/filename.ext---
---END_DELETE---

++ Ã–RNEK ++
---FILENAME: src/main.py---
# [EN] Main entrypoint | [TR] Ana giriÅŸ noktasÄ±
print("App started (BaÅŸladÄ±)")
---END_OF_FILE---
---DELETE: src/old.py---
---END_DELETE---

Print only file/silme bloklarÄ±nÄ± Ã¼ret, sohbet veya Ã¶neri eklenemez.
            `.trim();

            //---------- DeepSeek ile Ultra GÃ¼venli Ä°letiÅŸim ----------
            console.log("ğŸŸ¢ [Ultra Bot] DeepSeek API Ã§aÄŸrÄ±sÄ± baÅŸlatÄ±lÄ±yor...");
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: "PROJE TALEBÄ°: " + userMessage }
                ],
                temperature: 0.15,
                stream: false
              })
            });
            
            if (!response.ok) {
              const errText = await response.text();
              throwCritical("DeepSeek cevap vermedi: " + errText);
            }
            const data = await response.json();
            const aiReply = data.choices[0].message.content;

            //---------- Dosya BLOKLARI: Ekle/GÃ¼ncelle/Logla ----------
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            let match, filesDone=[], filesProblems=[];
            let resultLog = "### ğŸŸ¢ Ultra Enterprise SonuÃ§ Raporu\n";
            while ((match = fileRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              const fcont = match[2].trim();
              let sha = undefined;
              // SHA bul (varsa)
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                sha = existing.sha;
              } catch(_) {/* dosya yoksa */}
              // KayÄ±t/GÃ¼ncelle
              try {
                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `[ULTRA BOT]: ${fname} oluÅŸturuldu/gÃ¼ncellendi.`,
                  content: Buffer.from(fcont).toString('base64'), sha
                });
                filesDone.push(fname);
                resultLog += `\nâœ… \`${fname}\` oluÅŸturuldu/gÃ¼ncellendi.`;
              } catch (err) {
                filesProblems.push({fname, err: err.message});
                resultLog += `\nâŒ \`${fname}\` oluÅŸturulamadÄ±: ${err.message}`;
              }
            }

            //---------- SILME BLOKLARI: Ultra DetaylÄ± ----------
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            let delDone=[], delFail=[];
            let delMatch;
            while ((delMatch = delRE.exec(aiReply)) !== null) {
              const fname = delMatch[1].trim();
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                await github.rest.repos.deleteFile({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `[ULTRA BOT]: ${fname} ultra gÃ¼venli silindi.`,
                  sha: existing.sha
                });
                delDone.push(fname);
                resultLog += `\nğŸ—‘ï¸ \`${fname}\` silindi.`;
              } catch(err) {
                delFail.push({fname, err: err.message});
                resultLog += `\nâš ï¸ \`${fname}\` silinemedi: ${err.message}`;
              }
            }

            //---------- Nihai KURUMSAL RAPOR ve Log SonlandÄ±rma ----------
            resultLog += `\n\n**Ã–zet:** ${filesDone.length} dosya oluÅŸturuldu/gÃ¼ncellendi, ${delDone.length} dosya silindi.`;
            if (filesProblems.length > 0) {
              resultLog += `\n**OluÅŸturulamayanlar:** `;
              for (const fp of filesProblems) resultLog += `\n- \`${fp.fname}\`: ${fp.err}`;
            }
            if (delFail.length > 0) {
              resultLog += `\n**Silinemeyen dosyalar:** `;
              for (const df of delFail) resultLog += `\n- \`${df.fname}\`: ${df.err}`;
            }
            if (filesDone.length === 0 && delDone.length === 0) {
              resultLog += `\nâ— **AI YanÄ±tÄ± dosya/silme bloÄŸu Ã¼retmedi, cevap iÃ§eriÄŸi:**\n\n\`\`\`\n${aiReply}\n\`\`\``;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: resultLog
            });

            //---------- Ultra Professional: Nihai Not ----------
            console.log(`[ULTRA BOT] TÃ¼m proje talepleri %100 otomasyon ve kurumsal kaliteyle karÅŸÄ±landÄ±.`);
