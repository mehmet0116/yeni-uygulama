name: DeepSeek Pro Architect
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  proje_yonetici:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Depoyu Ã‡ek (Checkout)
        uses: actions/checkout@v3

      - name: DeepSeek Architect ile Ã‡alÄ±ÅŸ
        uses: actions/github-script@v6
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            // --- AYARLAR ---
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const cleanKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!cleanKey) throw new Error("API AnahtarÄ± eksik! LÃ¼tfen Secrets ayarlarÄ±nÄ± kontrol et.");

            // --- PROFESYONEL SÄ°STEM KOMUTU (PROMPT) ---
            const systemPrompt = `Sen DÃ¼nyanÄ±n en iyi YazÄ±lÄ±m MimarÄ± (Software Architect) ve Senior Developer'Ä±sÄ±n.
            GÃ¶revin: KullanÄ±cÄ±nÄ±n istediÄŸi projeyi, en iyi "Best Practice" kurallarÄ±na gÃ¶re tasarlamak ve kodlamak.
            
            KURALLAR:
            1. Asla tek bir dosya ile yetinme. EÄŸer proje gerektiriyorsa (Ã¶rn. CSS, JS ayrÄ± olmalÄ±) hepsini ayrÄ± ayrÄ± oluÅŸtur.
            2. KodlarÄ±n iÃ§ine aÃ§Ä±klayÄ±cÄ± yorum satÄ±rlarÄ± ekle.
            3. KlasÃ¶r yapÄ±sÄ±nÄ± kullan (Ã¶rn: src/main.py, assets/style.css).
            4. CevabÄ±nda SADECE dosya oluÅŸturma formatÄ±nÄ± kullan. Sohbet etme, sadece iÅŸ yap.
            
            Ã‡OK Ã–NEMLÄ° - Ã‡IKTI FORMATI:
            DosyalarÄ± oluÅŸturmak iÃ§in kesinlikle aÅŸaÄŸÄ±daki formatÄ± kullanmalÄ±sÄ±n. Birden fazla dosya iÃ§in bu bloÄŸu tekrar et:

            ---FILENAME: klasor/dosya_adi.uzantÄ±---
            [Buraya kodun tamamÄ± gelecek]
            ---END_OF_FILE---
            
            Ã–rnek:
            ---FILENAME: src/app.py---
            print("Hello World")
            ---END_OF_FILE---
            ---FILENAME: readme.md---
            # Proje DokÃ¼manÄ±
            ---END_OF_FILE---
            `;

            // --- DEEPSEEK ISTEGI ---
            console.log("DeepSeek'e baÄŸlanÄ±lÄ±yor...");
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${cleanKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: "PROJE TALEBÄ°: " + userMessage }
                ],
                temperature: 0.2, // Daha tutarlÄ± ve hatasÄ±z kod iÃ§in dÃ¼ÅŸÃ¼k sÄ±caklÄ±k
                stream: false
              })
            });

            if (!response.ok) {
              const errText = await response.text();
              throw new Error("DeepSeek HatasÄ±: " + errText);
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;

            // --- DOSYA AYRIÅTIRMA VE KAYDETME ---
            // Regex: TÃ¼m dosyalarÄ± tek tek yakalar
            const fileRegex = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            
            let match;
            let filesCreated = [];
            let processLog = "ğŸ¤– **DeepSeek Pro:** Proje dosyalarÄ± hazÄ±rlanÄ±yor...\n";

            while ((match = fileRegex.exec(aiReply)) !== null) {
              const fileName = match[1].trim();
              const fileContent = match[2].trim();
              
              console.log(`Ä°ÅŸleniyor: ${fileName}`);

              try {
                // Dosya var mÄ± kontrol et (SHA iÃ§in)
                let sha;
                try {
                  const { data: existingFile } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: fileName,
                  });
                  sha = existingFile.sha;
                } catch (e) { /* Dosya yoksa devam */ }

                // DosyayÄ± oluÅŸtur veya gÃ¼ncelle
                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: fileName,
                  message: `DeepSeek Pro: ${fileName} oluÅŸturuldu/gÃ¼ncellendi`,
                  content: Buffer.from(fileContent).toString('base64'),
                  sha: sha
                });

                filesCreated.push(fileName);
                processLog += `\nâœ… **OluÅŸturuldu:** \`${fileName}\``;
              } catch (err) {
                console.error(err);
                processLog += `\nâŒ **Hata:** \`${fileName}\` kaydedilemedi. (${err.message})`;
              }
            }

            // --- SONUÃ‡ RAPORU ---
            if (filesCreated.length === 0) {
              processLog += "\n\nâš ï¸ **UyarÄ±:** Kod iÃ§inde dosya formatÄ± bulunamadÄ±. Belki sadece aÃ§Ä±klama yapmÄ±ÅŸtÄ±r. Cevap ÅŸuydu:\n\n" + aiReply;
            } else {
              processLog += `\n\nğŸ¯ **Toplam ${filesCreated.length} dosya baÅŸarÄ±yla oluÅŸturuldu.** Kodlar sekmesini kontrol edebilirsin.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: processLog
            });
