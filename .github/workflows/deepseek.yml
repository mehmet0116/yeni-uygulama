name: DeepSeek ULTRA Enterprise Architect
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  ultra_architect:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Ultra GÃ¼venli Depo Checkout
        uses: actions/checkout@v4

      - name: DeepSeek ULTRA Architect Bot Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             * â•‘        ULTRA ENTERPRISE ARCHITECT BOT v2.3                    â•‘
             * â•‘        Powered by DeepSeek AI                                 â•‘
             * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */
            
            console.log("ğŸš€ [Ultra Bot] Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...");
            console.log(`ğŸ“ [Ultra Bot] Event: ${context.eventName}`);
            
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            function throwCritical(msg) {
              console.error(`â€¼ï¸ [Ultra Bot Kritik Hata]: ${msg}`);
              throw new Error("â€¼ï¸ [Ultra Bot Kritik]: " + msg);
            }
            
            if (!apiKey) throwCritical("API anahtarÄ± yÃ¼klÃ¼ deÄŸil! DEEPSEEK_API_KEY secret'Ä±nÄ± ekleyin.");
            if (!userMessage || userMessage.trim().length === 0) throwCritical("KullanÄ±cÄ± mesajÄ± boÅŸ!");
            
            console.log(`âœ… [Ultra Bot] Validasyonlar baÅŸarÄ±lÄ±. Mesaj uzunluÄŸu: ${userMessage.length} karakter`);

            const systemPrompt = `
            Sen 1 numaralÄ± global yazÄ±lÄ±m (ULTRA ENTERPRISE) mimarÄ±sÄ±n.
            Her geliÅŸtirme sorumluluÄŸun; kod, mimari, gÃ¼venlik, sÃ¼rdÃ¼rÃ¼lebilirlik, Ã¶lÃ§eklenebilirlik, ultra temizlik ve %100 iÅŸlevdir.

            ++ KURUMSAL KURALLAR ++
            - Daima modÃ¼ler ve en iyi klasÃ¶r yapÄ±sÄ±nÄ± kur.
            - Kod iÃ§ine anlamlÄ±, aÃ§Ä±klayÄ±cÄ±, ENGLISH ve TURKISH yorum ekle.
            - Kod, dÃ¶kÃ¼mantasyon, test, ortam dosyasÄ± (Ã¶r: .env.example), gereksiz bÄ±rakÄ±lamaz.
            - Her dosya sadece ilgi alanÄ±nÄ± kapsayacak.
            - En az: src/, tests/, docs/, configs/, .env.example, readme.md Ã§Ä±kmalÄ±.
            - Dosya silinmesi istenirse, kullanÄ±cÄ± "sil: ..." ile belirtir. Ultra gÃ¼venli sil.
            - HiÃ§bir ÅŸekilde sohbet ya da insan gibi mesajlaÅŸma, ek format, yan not kullanÄ±lamaz.
            - Her dosya ve silme iÅŸlemi Ã–ZEL formatta olmalÄ±.

            ++ DOSYA EKLE-GÃœNCELLE BLOK FORMAT ++
            ---FILENAME: path/name.ext---
            KODUN TAMAMI (gerekli aÃ§Ä±klamalarla)
            ---END_OF_FILE---

            ++ DOSYA SÄ°LME BLOK FORMAT ++
            ---DELETE: path/filename.ext---
            ---END_DELETE---

            Print only file/silme bloklarÄ±nÄ± Ã¼ret, sohbet veya Ã¶neri eklenemez.
            `.trim();

            console.log("ğŸŸ¢ [Ultra Bot] DeepSeek API Ã§aÄŸrÄ±sÄ± baÅŸlatÄ±lÄ±yor...");
            const apiUrl = "https://api.deepseek.com/chat/completions";
            
            try {
              const response = await fetch(apiUrl, {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${apiKey}`, 
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "deepseek-chat",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: "PROJE TALEBÄ°: " + userMessage }
                  ],
                  temperature: 0.15,
                  stream: false,
                  max_tokens: 4000
                })
              });
              
              if (!response.ok) {
                const errText = await response.text();
                throwCritical(`DeepSeek API hatasÄ± (${response.status}): ${errText}`);
              }
              
              const data = await response.json();
              
              if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throwCritical("API yanÄ±tÄ± beklenmeyen formatta");
              }
              
              const aiReply = data.choices[0].message.content;
              console.log(`ğŸ“ [Ultra Bot] AI yanÄ±t boyutu: ${aiReply.length} karakter`);

              console.log("ğŸ“ [Ultra Bot] Dosya bloklarÄ±nÄ± iÅŸlemeye baÅŸlÄ±yor...");
              const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
              let match, filesDone=[], filesProblems=[];
              let resultLog = "### ğŸŸ¢ Ultra Enterprise SonuÃ§ Raporu\n\n";
              resultLog += `**ğŸ“… Tarih:** ${new Date().toISOString()}\n`;
              resultLog += `**ğŸ‘¤ Ä°stek:** @${context.actor}\n\n`;
              
              let fileBlockFound = false;
              while ((match = fileRE.exec(aiReply)) !== null) {
                fileBlockFound = true;
                const fname = match[1].trim();
                const fcont = match[2].trim();
                
                if (!fname || fname.includes('..') || fname.startsWith('/')) {
                  filesProblems.push({fname, err: 'GeÃ§ersiz dosya adÄ±'});
                  resultLog += `\nâŒ \`${fname}\` - GeÃ§ersiz dosya adÄ±`;
                  continue;
                }
                
                let sha;
                try {
                  const { data: existing } = await github.rest.repos.getContent({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname
                  });
                  sha = existing.sha;
                } catch(_) {}
                
                try {
                  await github.rest.repos.createOrUpdateFileContents({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname,
                    message: `[ULTRA BOT]: ${fname} ${sha ? 'gÃ¼ncellendi' : 'oluÅŸturuldu'}`,
                    content: Buffer.from(fcont).toString('base64'), sha
                  });
                  filesDone.push(fname);
                  resultLog += `\nâœ… \`${fname}\` ${sha ? 'gÃ¼ncellendi' : 'oluÅŸturuldu'}`;
                } catch (err) {
                  filesProblems.push({fname, err: err.message});
                  resultLog += `\nâŒ \`${fname}\`: ${err.message}`;
                }
              }

              console.log("ğŸ—‘ï¸ [Ultra Bot] Silme bloklarÄ±nÄ± iÅŸlemeye baÅŸlÄ±yor...");
              const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
              let delDone=[], delFail=[];
              let delMatch;
              let deleteBlockFound = false;
              
              while ((delMatch = delRE.exec(aiReply)) !== null) {
                deleteBlockFound = true;
                const fname = delMatch[1].trim();
                
                const protectedFiles = ['.gitignore', 'README.md', '.github/workflows/deepseek.yml', 'package.json'];
                if (protectedFiles.includes(fname)) {
                  delFail.push({fname, err: 'KorumalÄ± dosya'});
                  resultLog += `\nğŸ›¡ï¸ \`${fname}\` - KorumalÄ± dosya`;
                  continue;
                }
                
                try {
                  const { data: existing } = await github.rest.repos.getContent({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname
                  });
                  await github.rest.repos.deleteFile({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname,
                    message: `[ULTRA BOT]: ${fname} silindi`,
                    sha: existing.sha
                  });
                  delDone.push(fname);
                  resultLog += `\nğŸ—‘ï¸ \`${fname}\` silindi`;
                } catch(err) {
                  delFail.push({fname, err: err.message});
                  resultLog += `\nâš ï¸ \`${fname}\`: ${err.message}`;
                }
              }

              const totalOps = filesDone.length + delDone.length;
              resultLog += `\n\n---\n### ğŸ“Š Ä°ÅŸlem Ã–zeti\n- âœ… **BaÅŸarÄ±lÄ±:** ${totalOps}\n- ğŸ“ **Dosyalar:** ${filesDone.length}\n- ğŸ—‘ï¸ **Silinen:** ${delDone.length}\n`;
              
              if (!fileBlockFound && !deleteBlockFound) {
                 resultLog += `\nâš ï¸ **UyarÄ±:** AI kod formatÄ± Ã¼retmedi. Cevap:\n\n${aiReply.substring(0, 500)}...`;
              }
              
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.issue.number,
                body: resultLog
              });
              
            } catch (error) {
              console.error(error);
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `### âŒ Kritik Hata\nHata: ${error.message}`
              });
              throw error;
            }

      - name: Ä°ÅŸlem Sonucunu Logla
        run: echo "Ultra Enterprise Architect iÅŸlemi tamamlandÄ±"
