name: DeepSeek AsistanÄ±
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  dosya_olusturucu:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: DeepSeek ile Iletisim ve Dosya Yazma
        uses: actions/github-script@v6
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            
            // API Key temizliÄŸi
            const cleanKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            if (!cleanKey) throw new Error("API AnahtarÄ± eksik!");

            // DeepSeek'e Ã¶zel talimat gÃ¶nderiyoruz: Dosya adÄ± ve iÃ§eriÄŸi ayrÄ±ÅŸtÄ±rÄ±labilir olsun.
            const systemPrompt = `Sen uzman bir yazÄ±lÄ±mcÄ±sÄ±n. KullanÄ±cÄ± senden bir kod veya dosya isterse, cevabÄ±nÄ± ÅU FORMATTA VERMEK ZORUNDASIN:
            
            ---FILENAME: dosya_adi.uzantÄ±---
            [Buraya kodun tamamÄ± gelecek]
            ---END_OF_FILE---
            
            EÄŸer sadece sohbet ediyorsan normal cevap ver. TÃ¼rkÃ§e konuÅŸ.`;

            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${cleanKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userMessage }
                ],
                stream: false
              })
            });

            if (!response.ok) {
              console.log(await response.text());
              throw new Error("DeepSeek API hatasi");
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;
            
            // CevabÄ±n iÃ§inde dosya formatÄ± var mÄ± diye kontrol et
            let finalComment = "ğŸ¤– **DeepSeek CevabÄ±:**\n" + aiReply;
            
            // Regex ile dosya adÄ± ve iÃ§eriÄŸini yakalayalÄ±m
            const fileMatch = aiReply.match(/---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/);

            if (fileMatch) {
              const fileName = fileMatch[1].trim();
              const fileContent = fileMatch[2].trim();
              
              // DosyayÄ± GitHub'da oluÅŸtur veya gÃ¼ncelle
              try {
                // Mevcut dosyayÄ± kontrol et (SHA almak iÃ§in)
                let sha;
                try {
                  const { data: existingFile } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: fileName,
                  });
                  sha = existingFile.sha;
                } catch (e) {
                  // Dosya yoksa sorun deÄŸil, yeni oluÅŸturulacak
                }

                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: fileName,
                  message: `DeepSeek tarafindan olusturuldu: ${fileName}`,
                  content: Buffer.from(fileContent).toString('base64'),
                  sha: sha
                });

                finalComment += `\n\nâœ… **BAÅARILI:** \`${fileName}\` dosyasÄ± deponuza kaydedildi! Kodlar (Code) sekmesinden gÃ¶rebilirsiniz.`;
              } catch (error) {
                console.error(error);
                finalComment += `\n\nâŒ **HATA:** Dosya oluÅŸturulurken bir sorun Ã§Ä±ktÄ±: ${error.message}`;
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: finalComment
            });
