name: DeepSeek ULTRA Enterprise Architect
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  ultra_architect:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Ultra GÃ¼venli Depo Checkout
        uses: actions/checkout@v4

      - name: DeepSeek ULTRA Architect Bot Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             * â•‘        ULTRA ENTERPRISE ARCHITECT BOT v2.4 (LIMIT FIX)        â•‘
             * â•‘        Powered by DeepSeek AI                                 â•‘
             * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */
            
            console.log("ğŸš€ [Ultra Bot v2.4] Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...");
            
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("API AnahtarÄ± eksik!");

            // Uzun cevaplarda hata vermemesi iÃ§in raporu kÄ±saltan fonksiyon
            function truncateComment(text, maxLength = 65000) {
              if (text.length <= maxLength) return text;
              return text.substring(0, maxLength) + "\n\n... (Cevap Ã§ok uzundu, GitHub sÄ±nÄ±rÄ± nedeniyle kesildi. Ancak dosyalar iÅŸlendi.)";
            }

            const systemPrompt = `
            Sen 1 numaralÄ± global yazÄ±lÄ±m mimarÄ±sÄ±n.
            GÃ¶revin: KullanÄ±cÄ±nÄ±n istediÄŸi projeyi tasarlamak ve kodlamak.
            
            KURALLAR:
            - ModÃ¼ler klasÃ¶r yapÄ±sÄ± kullan.
            - Kod iÃ§ine aÃ§Ä±klayÄ±cÄ± yorumlar ekle.
            - "Her ÅŸeyi tek dosyaya yazma", bÃ¶l.
            
            Ã‡OK Ã–NEMLÄ° FORMAT (Bunu bozma):
            ---FILENAME: yol/dosya_adi.uzantÄ±---
            [Kod iÃ§eriÄŸi]
            ---END_OF_FILE---
            
            Silme iÅŸlemi iÃ§in:
            ---DELETE: yol/dosya_adi.uzantÄ±---
            ---END_DELETE---
            `.trim();

            console.log("ğŸŸ¢ DeepSeek API'ye baÄŸlanÄ±lÄ±yor...");
            
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: "PROJE TALEBÄ°: " + userMessage }
                ],
                temperature: 0.1, // Daha kararlÄ± kod iÃ§in
                stream: false,
                max_tokens: 8000 // Uzun kodlara izin ver
              })
            });

            if (!response.ok) {
              const err = await response.text();
              throw new Error(`DeepSeek API HatasÄ±: ${err}`);
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;
            
            console.log(`ğŸ“ AI YanÄ±t UzunluÄŸu: ${aiReply.length} karakter`);

            // --- DOSYA Ä°ÅLEME ---
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            
            let match;
            let filesDone = [];
            let filesDeleted = [];
            let errors = [];

            // 1. Dosya OluÅŸturma
            while ((match = fileRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              const fcont = match[2].trim();
              
              try {
                // SHA al (gÃ¼ncelleme iÃ§in)
                let sha;
                try {
                  const { data: existing } = await github.rest.repos.getContent({
                    owner: context.repo.owner, repo: context.repo.repo, path: fname
                  });
                  sha = existing.sha;
                } catch (e) {}

                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `DeepSeek v2.4: ${fname}`,
                  content: Buffer.from(fcont).toString('base64'),
                  sha: sha
                });
                filesDone.push(fname);
                console.log(`âœ… OluÅŸturuldu: ${fname}`);
              } catch (err) {
                errors.push(`${fname}: ${err.message}`);
                console.error(`âŒ Hata (${fname}): ${err.message}`);
              }
            }

            // 2. Dosya Silme
            while ((match = delRE.exec(aiReply)) !== null) {
              const fname = match[1].trim();
              
              // KorumalÄ± dosyalar
              if (['README.md', '.github/workflows/deepseek.yml'].includes(fname)) continue;

              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname
                });
                await github.rest.repos.deleteFile({
                  owner: context.repo.owner, repo: context.repo.repo, path: fname,
                  message: `DeepSeek Silme: ${fname}`,
                  sha: existing.sha
                });
                filesDeleted.push(fname);
                console.log(`ğŸ—‘ï¸ Silindi: ${fname}`);
              } catch (err) {
                // Dosya zaten yoksa hata verme
              }
            }

            // --- RAPOR HAZIRLAMA (KÄ±saltÄ±lmÄ±ÅŸ) ---
            let report = `### ğŸ¤– DeepSeek v2.4 Raporu\n`;
            report += `**ğŸ“Š Ã–zet:** ${filesDone.length} dosya oluÅŸturuldu, ${filesDeleted.length} silindi.\n\n`;
            
            if (filesDone.length > 0) {
              report += `#### âœ… OluÅŸturulanlar:\n`;
              filesDone.forEach(f => report += `- \`${f}\`\n`);
            }
            
            if (errors.length > 0) {
              report += `\n#### âŒ Hatalar:\n`;
              errors.forEach(e => report += `- ${e}\n`);
            }

            // GitHub yorum sÄ±nÄ±rÄ±nÄ± aÅŸmamak iÃ§in AI cevabÄ±nÄ±n sadece baÅŸÄ±nÄ± ekle
            // Kodlar zaten dosyaya yazÄ±ldÄ±, yoruma yazmaya gerek yok.
            report += `\n---\n**Not:** Kodlar baÅŸarÄ±yla dosyalarÄ±nÄ±za kaydedildi. Kodlar (Code) sekmesinden inceleyebilirsiniz.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
